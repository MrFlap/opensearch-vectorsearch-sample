FROM opensearchstaging/ci-runner:ci-runner-al2-opensearch-build-v1
USER root
#RUN sed -i -e 's/mirror.centos.org/mirrormanager.fedoraproject.org\/mirrors\/CentOS/g' /etc/yum.repos.d/CentOS-Base.repo
#RUN sed -i 's/^plugins=.*/plugins=0/' /etc/yum.conf
#RUN yum clean all
#RUN yum repolist
RUN yum install jemalloc lapack-devel blas-devel wget tar -y
ENV JAVA_HOME="/opt/java/openjdk-21"
ENV OS_VERSION="2.15.0"
ENV IS_SNAPSHOT="true"
ENV MEMORY_FIX="true"
ADD build-opensearch.sh /
RUN bash /build-opensearch.sh
# Change ownership of folders to ci-runner user as opensearch cannot run as root
ADD setup-cluster.sh /home/ci-runner
RUN cd /home/ci-runner
RUN chown -R 1000:1000 `pwd`
USER ci-runner
RUN chmod 755 ./setup-cluster.sh
ENTRYPOINT [ "./setup-cluster.sh", "-h", "1g", "-c", "95" ]
